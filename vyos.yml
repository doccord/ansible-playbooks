---
- hosts: vyos
  gather_facts: false
  tasks:
    - name: "Gather Config"
      vyos.vyos.vyos_facts:
        gather_subset: "config"
      tags:
        - always

    #
    # System
    #
    - name: "Set hostname"
      vyos.vyos.vyos_system:
        host_name: "{{ inventory_hostname }}"
        state: "present"
    - name: "Set nameservers"
      vyos.vyos.vyos_system:
        name_servers:
          - "127.0.0.1"
      tags:
        - "dns"
    - name: "Set domain search suffixes"
      vyos.vyos.vyos_system:
        domain_search: "{{ common__nameservers.search }}"
    - name: "Remove default NTP servers"
      vyos.vyos.vyos_config:
        lines:
          - "delete system ntp server {{ item }}"
      loop:
        - "0.pool.ntp.org"
        - "1.pool.ntp.org"
        - "2.pool.ntp.org"
      when: item in ansible_net_config[0]
    - name: "Set NTP servers"
      vyos.vyos.vyos_config:
        lines:
          - "set system ntp server {{ common__ntp_pool }} pool"
          - "set system time-zone US/Pacific"
        save: true

    #
    # Interfaces
    #
    - name: "Set the device interfaces"
      vyos.vyos.vyos_interfaces:
        config:
          - name: "{{ vyos__lan_interface }}"
            description: "UNIFI-MAN - management vlan for Unifi devices ({{ ansible_managed }})"
            enabled: true
            vifs:
              - vlan_id: 9
                description: "SYNC - used for router synchronization communication ({{ ansible_managed }})"
              - vlan_id: 10
                description: "MAN - management vlan ({{ ansible_managed }})"
              - vlan_id: 15
                description: "GWORK - work-friendly addressed network ({{ ansible_managed }})"
              - vlan_id: 66
                description: "IOT - internet of things: WAN access, but not much else ({{ ansible_managed }})"
              - vlan_id: 67
                description: "NOWAN - internet of shit: no WAN or other access ({{ ansible_managed }})"
              - vlan_id: 82
                description: "SERVICE82 - installation02 (unifi controller) ({{ ansible_managed }})"
              - vlan_id: 100
                description: "ROUTER-LAB - acts as a WAN for testing ({{ ansible_managed }})"
              - vlan_id: 117
                description: "HOME - home network with home services ({{ ansible_managed }})"
              - vlan_id: 131
                description: "GUEST - used for guest wifi ({{ ansible_managed }})"
          - name: "{{ vyos__wan_cellular_interface }}"
            description: "Cellular WAN ({{ ansible_managed }})"
            enabled: true
          - name: "{{ vyos__wan_centurylink_interface }}"
            description: "CenturyLink WAN ({{ ansible_managed }})"
            enabled: true
            vifs:
              - vlan_id: 201
                description: "CenturyLink PPPOE ({{ ansible_managed }})"
        state: merged
    - name: "Setup CenturyLink PPPOE"
      vyos.vyos.vyos_config:
        lines:
          - "set interfaces pppoe pppoe0 authentication password {{ vyos__wan_centurylink_password }}"
          - "set interfaces pppoe pppoe0 authentication user {{ vyos__wan_centurylink_username }}"
          - "set interfaces pppoe pppoe0 default-route none"
          - "set interfaces pppoe pppoe0 mtu 1492"
          - "set interfaces pppoe pppoe0 no-peer-dns"
          - "set interfaces pppoe pppoe0 source-interface {{ vyos__wan_centurylink_interface }}.201"
        save: yes
    - name: "Set interfaces addresses"
      vyos.vyos.vyos_config:
        lines:
          # UNIFI-MAN
          - "set interfaces ethernet {{ vyos__lan_interface }} address 10.1.0.{{ vyos__host_id_ipv4 }}/24"
          - "set interfaces ethernet {{ vyos__lan_interface }} address fd36:3eb3:43b0:1::{{ vyos__host_id_ipv6 }}/64"
          # SYNC
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 9 address 10.9.0.{{ vyos__host_id_ipv4 }}/24"
          # MAN
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 10 address 10.10.0.{{ vyos__host_id_ipv4 }}/24"
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 10 address fd36:3eb3:43b0:a::{{ vyos__host_id_ipv6 }}/64"
          # GWORK
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 15 address 192.168.1.{{ vyos__host_id_ipv4 }}/24"
          # IOT
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 66 address 10.66.0.{{ vyos__host_id_ipv4 }}/24"
          # NOWAN
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 67 address 10.67.0.{{ vyos__host_id_ipv4 }}/24"
          # SERVICE82
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 82 address 10.82.0.{{ vyos__host_id_ipv4 }}/24"
          # ROUTER-LAB
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 100 address 10.100.0.{{ vyos__host_id_ipv4 }}/24"
          # HOME
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 117 address 10.117.0.{{ vyos__host_id_ipv4 }}/23"
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 117 address fd36:3eb3:43b0:75::{{ vyos__host_id_ipv6 }}/64"
          # GUEST
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 131 address 10.131.0.{{ vyos__host_id_ipv4 }}/24"
          # WAN-CELLULAR
          - "set interfaces ethernet {{ vyos__wan_cellular_interface }} address 172.16.5.{{ vyos__host_id_ipv4 }}/24"
        save: yes
    - set_fact:
        lan_interfaces_with_wan_access:
          # UNIFI-MAN
          - interface: "{{ vyos__lan_interface }}"
            ipv4_network: "10.1.0.0/24"
          # MAN
          - interface: "{{ vyos__lan_interface }}.10"
            ipv4_network: "10.10.0.0/24"
          # GWORK
          - interface: "{{ vyos__lan_interface }}.15"
            ipv4_network: "192.168.1.0/24"
          # IOT
          - interface: "{{ vyos__lan_interface }}.66"
            ipv4_network: "10.66.0.0/24"
          # SERVICE82
          - interface: "{{ vyos__lan_interface }}.82"
            ipv4_network: "10.82.0.0/24"
          # ROUTER-LAB
          - interface: "{{ vyos__lan_interface }}.100"
            ipv4_network: "10.100.0.0/24"
          # HOME
          - interface: "{{ vyos__lan_interface }}.117"
            ipv4_network: "10.117.0.0/23"
          # GUEST
          - interface: "{{ vyos__lan_interface }}.131"
            ipv4_network: "10.131.0.0/24"
      tags:
        - always
    - name: "Setup pppoe0 activation script"
      ansible.builtin.copy:
        dest: "/config/scripts/activate-pppoe0.script"
        content: |
          #!/bin/vbash

          # Safeguard to ensure the script is called with the correct group.
          if [ "$(id -g -n)" != 'vyattacfg' ] ; then
            exec sg vyattacfg -c "/bin/vbash $(readlink -f $0) $@"
          fi

          source /opt/vyatta/etc/functions/script-template
          configure
          delete interfaces pppoe pppoe0 disable
          commit
        owner: "root"
        group: "vyattacfg"
        mode: "u=rwx,g=rx,o=rx"
      become: true
      vars:
        ansible_connection: "ssh"
    - name: "Setup pppoe0 disable script"
      ansible.builtin.copy:
        dest: "/config/scripts/disable-pppoe0.script"
        content: |
          #!/bin/vbash

          # Safeguard to ensure the script is called with the correct group.
          if [ "$(id -g -n)" != 'vyattacfg' ] ; then
            exec sg vyattacfg -c "/bin/vbash $(readlink -f $0) $@"
          fi

          source /opt/vyatta/etc/functions/script-template
          configure
          set interfaces pppoe pppoe0 disable
          commit
        owner: "root"
        group: "vyattacfg"
        mode: "u=rwx,g=rx,o=rx"
      become: true
      vars:
        ansible_connection: "ssh"
    - name: "Setup vrrp"
      vyos.vyos.vyos_config:
        lines:
          # UNIFI-MAN
          - "set high-availability vrrp group UNIFI-MAN-v4 description '{{ ansible_managed }}'"
          - "set high-availability vrrp group UNIFI-MAN-v4 interface {{ vyos__lan_interface }}"
          - "set high-availability vrrp group UNIFI-MAN-v4 priority {{ vyos__vrrp_priority }}"
          - "set high-availability vrrp group UNIFI-MAN-v4 virtual-address 10.1.0.1/24"
          - "set high-availability vrrp group UNIFI-MAN-v4 vrid 1"
          - "set high-availability vrrp group UNIFI-MAN-v6 description '{{ ansible_managed }}'"
          - "set high-availability vrrp group UNIFI-MAN-v6 interface {{ vyos__lan_interface }}"
          - "set high-availability vrrp group UNIFI-MAN-v6 priority {{ vyos__vrrp_priority }}"
          - "set high-availability vrrp group UNIFI-MAN-v6 virtual-address fd36:3eb3:43b0:1::1/64"
          - "set high-availability vrrp group UNIFI-MAN-v6 vrid 2"
          - "set high-availability vrrp sync-group MAIN member UNIFI-MAN-v4"
          - "set high-availability vrrp sync-group MAIN member UNIFI-MAN-v6"
          # SYNC
          - "set high-availability vrrp group SYNC-v4 description '{{ ansible_managed }}'"
          - "set high-availability vrrp group SYNC-v4 hello-source-address 10.9.0.{{ vyos__host_id_ipv4 }}"
          - "set high-availability vrrp group SYNC-v4 interface {{ vyos__lan_interface }}.9"
          - "set high-availability vrrp group SYNC-v4 peer-address 10.9.0.{{ vyos__peer_host_id_ipv4 }}"
          - "set high-availability vrrp group SYNC-v4 priority {{ vyos__vrrp_priority }}"
          - "set high-availability vrrp group SYNC-v4 transition-script backup /config/scripts/disable-pppoe0.script"
          - "set high-availability vrrp group SYNC-v4 transition-script master /config/scripts/activate-pppoe0.script"
          - "set high-availability vrrp group SYNC-v4 virtual-address 10.9.0.1/24"
          - "set high-availability vrrp group SYNC-v4 vrid 9"
          - "set high-availability vrrp sync-group MAIN member SYNC-v4"
          # MAN
          - "set high-availability vrrp group MAN-v4 description '{{ ansible_managed }}'"
          - "set high-availability vrrp group MAN-v4 interface {{ vyos__lan_interface }}.10"
          - "set high-availability vrrp group MAN-v4 priority {{ vyos__vrrp_priority }}"
          - "set high-availability vrrp group MAN-v4 virtual-address 10.10.0.1/24"
          - "set high-availability vrrp group MAN-v4 vrid 10"
          - "set high-availability vrrp group MAN-v6 description '{{ ansible_managed }}'"
          - "set high-availability vrrp group MAN-v6 interface {{ vyos__lan_interface }}.10"
          - "set high-availability vrrp group MAN-v6 priority {{ vyos__vrrp_priority }}"
          - "set high-availability vrrp group MAN-v6 virtual-address fd36:3eb3:43b0:a::1/64"
          - "set high-availability vrrp group MAN-v6 vrid 11"
          - "set high-availability vrrp sync-group MAIN member MAN-v4"
          - "set high-availability vrrp sync-group MAIN member MAN-v6"
          # GWORK
          - "set high-availability vrrp group GWORK-v4 description '{{ ansible_managed }}'"
          - "set high-availability vrrp group GWORK-v4 interface {{ vyos__lan_interface }}.15"
          - "set high-availability vrrp group GWORK-v4 priority {{ vyos__vrrp_priority }}"
          - "set high-availability vrrp group GWORK-v4 virtual-address 192.168.1.1/24"
          - "set high-availability vrrp group GWORK-v4 vrid 15"
          - "set high-availability vrrp sync-group MAIN member GWORK-v4"
          # IOT
          - "set high-availability vrrp group IOT-v4 description '{{ ansible_managed }}'"
          - "set high-availability vrrp group IOT-v4 interface {{ vyos__lan_interface }}.66"
          - "set high-availability vrrp group IOT-v4 priority {{ vyos__vrrp_priority }}"
          - "set high-availability vrrp group IOT-v4 virtual-address 10.66.0.1/24"
          - "set high-availability vrrp group IOT-v4 vrid 66"
          - "set high-availability vrrp sync-group MAIN member IOT-v4"
          # NOWAN
          - "set high-availability vrrp group NOWAN-v4 description '{{ ansible_managed }}'"
          - "set high-availability vrrp group NOWAN-v4 interface {{ vyos__lan_interface }}.67"
          - "set high-availability vrrp group NOWAN-v4 priority {{ vyos__vrrp_priority }}"
          - "set high-availability vrrp group NOWAN-v4 virtual-address 10.67.0.1/24"
          - "set high-availability vrrp group NOWAN-v4 vrid 67"
          - "set high-availability vrrp sync-group MAIN member NOWAN-v4"
          # SERVICE82
          - "set high-availability vrrp group SERVICE82-v4 description '{{ ansible_managed }}'"
          - "set high-availability vrrp group SERVICE82-v4 interface {{ vyos__lan_interface }}.82"
          - "set high-availability vrrp group SERVICE82-v4 priority {{ vyos__vrrp_priority }}"
          - "set high-availability vrrp group SERVICE82-v4 virtual-address 10.82.0.1/24"
          - "set high-availability vrrp group SERVICE82-v4 vrid 82"
          - "set high-availability vrrp sync-group MAIN member SERVICE82-v4"
          # ROUTER-LAB
          - "set high-availability vrrp group ROUTER-LAB-v4 description '{{ ansible_managed }}'"
          - "set high-availability vrrp group ROUTER-LAB-v4 interface {{ vyos__lan_interface }}.100"
          - "set high-availability vrrp group ROUTER-LAB-v4 priority {{ vyos__vrrp_priority }}"
          - "set high-availability vrrp group ROUTER-LAB-v4 virtual-address 10.100.0.1/24"
          - "set high-availability vrrp group ROUTER-LAB-v4 vrid 100"
          - "set high-availability vrrp sync-group MAIN member ROUTER-LAB-v4"
          # HOME
          - "set high-availability vrrp group HOME-v4 description '{{ ansible_managed }}'"
          - "set high-availability vrrp group HOME-v4 interface {{ vyos__lan_interface }}.117"
          - "set high-availability vrrp group HOME-v4 priority {{ vyos__vrrp_priority }}"
          - "set high-availability vrrp group HOME-v4 virtual-address 10.117.0.1/23"
          - "set high-availability vrrp group HOME-v4 vrid 117"
          - "set high-availability vrrp group HOME-v6 description '{{ ansible_managed }}'"
          - "set high-availability vrrp group HOME-v6 interface {{ vyos__lan_interface }}.117"
          - "set high-availability vrrp group HOME-v6 priority {{ vyos__vrrp_priority }}"
          - "set high-availability vrrp group HOME-v6 virtual-address fd36:3eb3:43b0:75::1/64"
          - "set high-availability vrrp group HOME-v6 vrid 118"
          - "set high-availability vrrp sync-group MAIN member HOME-v4"
          - "set high-availability vrrp sync-group MAIN member HOME-v6"
          # GUEST
          - "set high-availability vrrp group GUEST-v4 description '{{ ansible_managed }}'"
          - "set high-availability vrrp group GUEST-v4 interface {{ vyos__lan_interface }}.131"
          - "set high-availability vrrp group GUEST-v4 priority {{ vyos__vrrp_priority }}"
          - "set high-availability vrrp group GUEST-v4 virtual-address 10.131.0.1/24"
          - "set high-availability vrrp group GUEST-v4 vrid 131"
          - "set high-availability vrrp sync-group MAIN member GUEST-v4"
          # WAN-CELLULAR
          - "set high-availability vrrp group WAN-CELLULAR-v4 description '{{ ansible_managed }}'"
          - "set high-availability vrrp group WAN-CELLULAR-v4 interface {{ vyos__wan_cellular_interface }}"
          - "set high-availability vrrp group WAN-CELLULAR-v4 priority {{ vyos__vrrp_priority }}"
          - "set high-availability vrrp group WAN-CELLULAR-v4 virtual-address 172.16.5.2/24"
          - "set high-availability vrrp group WAN-CELLULAR-v4 vrid 255"
          - "set high-availability vrrp sync-group MAIN member WAN-CELLULAR-v4"
        save: yes

    #
    # Firewall
    #
    - name: "Set global firewall settings"
      vyos.vyos.vyos_firewall_global:
        config:
          config_trap: no
          group:
            address_group:
              - name: "PEER-v4"
                description: "IP Addresses of our Peer Router ({{ ansible_managed }})"
                members:
                  - address: "10.1.0.{{ vyos__peer_host_id_ipv4 }}"
                  - address: "10.10.0.{{ vyos__peer_host_id_ipv4 }}"
                  - address: "192.168.1.{{ vyos__peer_host_id_ipv4 }}"
                  - address: "10.66.0.{{ vyos__peer_host_id_ipv4 }}"
                  - address: "10.67.0.{{ vyos__peer_host_id_ipv4 }}"
                  - address: "10.117.0.{{ vyos__peer_host_id_ipv4 }}"
                  - address: "10.131.0.{{ vyos__peer_host_id_ipv4 }}"
              - name: "MAN-TALKERS-from-HOME-v4"
                description: "IP Addresses allowed to talk to devices on MAN ({{ ansible_managed }})"
                members:
                  # sdwilsh-desktop
                  - address: "10.117.0.31"
              - name: "MAN-TALKERS-from-HOME-v6"
                description: "IP Addresses allowed to talk to devices on MAN ({{ ansible_managed }})"
                afi: "ipv6"
                members:
                  # sdwilsh-desktop
                  - address: "fd36:3eb3:43b0:75::1f"
              - name: "NTP-SERVICES-v4"
                description: "NTP services ({{ ansible_managed }})"
                members:
                  - address: "10.117.0.50"
                  - address: "10.117.0.51"
                  - address: "10.117.0.52"
              - name: "NTP-SERVICES-v6"
                description: "NTP services ({{ ansible_managed }})"
                afi: "ipv6"
                members:
                  - address: "fd36:3eb3:43b0:75::33"
                  - address: "fd36:3eb3:43b0:75::34"
              - name: "NOWAN-TALKERS-from-HOME-v4"
                description: "IP Addresses allowed to talk to devices on NOWAN ({{ ansible_managed }})"
                members:
                  # cortana.hogs.tswn.us
                  - address: "10.117.0.19"
                  # iona.hogs.tswn.us
                  - address: "10.117.0.27"
                  # sdwilsh-desktop
                  - address: "10.117.0.31"
              - name: "NOWAN-TALKERS-from-HOME-v6"
                description: "IP Addresses allowed to talk to devices on NOWAN ({{ ansible_managed }})"
                afi: "ipv6"
                members:
                  # cortana.hogs.tswn.us
                  - address: "fd36:3eb3:43b0:75::13"
                  # sdwilsh-desktop
                  - address: "fd36:3eb3:43b0:75::1f"
              - name: "ZABBIX-SERVER-v4"
                description: "The v4 zabbix-server.hogs.tswn.us addresses"
                afi: "ipv4"
                members:
                  - address: "10.117.0.32"
              - name: "ZABBIX-SERVER-v6"
                description: "The v4 zabbix-server.hogs.tswn.us addresses"
                afi: "ipv6"
                members:
                  - address: "fd36:3eb3:43b0:75::20"
                  - address: "fd36:3eb3:43b0:75:42:aff:fe75:20"
            network_group:
              - name: "RFC1918-v4"
                description: "IPv4 Private Address Space ({{ ansible_managed }})"
                members:
                  - address: "192.168.0.0/16"
                  - address: "172.16.0.0/12"
                  - address: "10.0.0.0/8"
            port_group:
              - name: "DNS"
                description: "{{ ansible_managed }}"
                members:
                  - port: "53"
              - name: "NTP"
                description: "{{ ansible_managed }}"
                members:
                  - port: "123"
              - name: "UNIFI-DEVICE-TCP"
                description: "Ports used by the Unifi Controller to talk to devices over TCP ({{ ansible_managed }})"
                members:
                  - port: "8080"
                  - port: "6789"
              - name: "UNIFI-DEVICE-UDP"
                description: "Ports used by the Unifi Controller to talk to devices over UDP ({{ ansible_managed }})"
                members:
                  - port: "3478"
              - name: "UNIFI-WEB-TCP"
                description: "Ports used by the Unifi Controller for clients ({{ ansible_managed }})"
                members:
                  - port: "8443"
          log_martians: yes
          ping:
            all: yes
            broadcast: no
          route_redirects:
            - afi: ipv4
              icmp_redirects:
                receive: no
                send: yes
              ip_src_route: no
            - afi: ipv6
              icmp_redirects:
                receive: no
                send: yes
              ip_src_route: no
          syn_cookies: yes
          twa_hazards_protection: yes
          validation: disable
        state: replaced
      tags:
        - firewall

    - name: "Set MSS clamping on PPPOE interface"
      vyos.vyos.vyos_config:
        lines:
          - "set firewall options interface pppoe0 adjust-mss 1452"
      tags:
        - firewall

    - name: "Set the firewall rules"
      vyos.vyos.vyos_firewall_rules:
        config:
          - afi: "ipv4"
            rule_sets:
              - name: "GUEST-from-LOCAL-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    protocol: "vrrp"
                  - number: 500
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "GUEST-from-WAN-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
              - name: "GWORK-from-LOCAL-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    protocol: "vrrp"
                  - number: 500
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "GWORK-from-WAN-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
              - name: "HOME-from-IOT-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 20
                    description: "Allow NTP ({{ ansible_managed }})"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      group:
                        address_group: "NTP-SERVICES-v4"
                        port_group: "NTP"
              - name: "HOME-from-LOCAL-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    protocol: "vrrp"
                  - number: 500
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "HOME-from-MAN-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
                  - number: 20
                    description: "Allow NTP ({{ ansible_managed }})"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      group:
                        address_group: "NTP-SERVICES-v4"
                        port_group: "NTP"
                  - number: 30
                    description: "Allow ARA Connections ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp"
                    state:
                      new: true
                    destination:
                      address: "10.117.0.30"
                      port: "8000"
                  - number: 40
                    description: "Allow zabbix-agent Connections ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp"
                    state:
                      new: true
                    destination:
                      group:
                        address_group: "ZABBIX-SERVER-v4"
                      port: "10051"
              - name: "HOME-from-NOWAN-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 20
                    description: "Allow NTP ({{ ansible_managed }})"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      group:
                        address_group: "NTP-SERVICES-v4"
                        port_group: "NTP"
              - name: "HOME-from-SERVICE82-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 20
                    description: "Allow NTP ({{ ansible_managed }})"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      group:
                        address_group: "NTP-SERVICES-v4"
                        port_group: "NTP"
              - name: "HOME-from-UNIFI-MAN-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 20
                    description: "Allow NTP ({{ ansible_managed }})"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      group:
                        address_group: "NTP-SERVICES-v4"
                        port_group: "NTP"
              - name: "HOME-from-WAN-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
              - name: "IOT-from-HOME-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
              - name: "IOT-from-LOCAL-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    protocol: "vrrp"
                  - number: 500
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "IOT-from-WAN-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
              - name: "LOCAL-from-GUEST-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
                  - number: 4
                    description: "Allow DHCP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "udp"
                    source:
                      port: "68"
                    destination:
                      port: "67"
                  - number: 10
                    description: "Allow DNS ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp_udp"
                    state:
                      new: true
                    destination:
                      group:
                        port_group: "DNS"
                  - number: 5
                    description: "Allow dhcp-sync ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp"
                    destination:
                      port: "520"
                    source:
                      group:
                        address_group: "PEER-v4"
              - name: "LOCAL-from-GWORK-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
                  - number: 4
                    description: "Allow DHCP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "udp"
                    source:
                      port: "68"
                    destination:
                      port: "67"
                  - number: 5
                    description: "Allow dhcp-sync ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp"
                    destination:
                      port: "520"
                    source:
                      group:
                        address_group: "PEER-v4"
                  - number: 10
                    description: "Allow DNS ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp_udp"
                    state:
                      new: true
                    destination:
                      group:
                        port_group: "DNS"
              - name: "LOCAL-from-HOME-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
                  - number: 4
                    description: "Allow DHCP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "udp"
                    source:
                      port: "68"
                    destination:
                      port: "67"
                  - number: 5
                    description: "Allow dhcp-sync ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp"
                    destination:
                      port: "520"
                    source:
                      group:
                        address_group: "PEER-v4"
                  - number: 10
                    description: "Allow DNS ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp_udp"
                    state:
                      new: true
                    destination:
                      group:
                        port_group: "DNS"
                  - number: 50
                    description: "Drop broadcast traffic ({{ ansible_managed }})"
                    action: "drop"
                    destination:
                      address: "255.255.255.255"
                  - number: 60
                    description: "Drop broadcast traffic ({{ ansible_managed }})"
                    action: "drop"
                    destination:
                      address: "10.117.1.255"
              - name: "LOCAL-from-IOT-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
                  - number: 4
                    description: "Allow DHCP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp_udp"
                    source:
                      port: "68"
                    destination:
                      port: "67"
                  - number: 5
                    description: "Allow dhcp-sync ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp"
                    destination:
                      port: "520"
                    source:
                      group:
                        address_group: "PEER-v4"
                  - number: 10
                    description: "Allow DNS ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "udp"
                    state:
                      new: true
                    destination:
                      group:
                        port_group: "DNS"
              - name: "LOCAL-from-MAN-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
                  - number: 4
                    description: "Allow DHCP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "udp"
                    source:
                      port: "68"
                    destination:
                      port: "67"
                  - number: 5
                    description: "Allow dhcp-sync ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp"
                    destination:
                      port: "520"
                    source:
                      group:
                        address_group: "PEER-v4"
                  - number: 10
                    description: "Allow DNS ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp_udp"
                    state:
                      new: true
                    destination:
                      group:
                        port_group: "DNS"
                  - number: 50
                    description: "Allow SSH ({{ ansible_managed }})"
                    action: "accept"
                    destination:
                      port: "22"
                    protocol: "tcp"
                    state:
                      new: true
                  - number: 60
                    description: "Drop Eaton Alarms Broadcast ({{ ansible_managed }})"
                    action: "drop"
                    protocol: "udp"
                    destination:
                      address: "255.255.255.255"
                      port: "4680"
              - name: "LOCAL-from-NOWAN-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
                  - number: 4
                    description: "Allow DHCP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "udp"
                    source:
                      port: "68"
                    destination:
                      port: "67"
                  - number: 5
                    description: "Allow dhcp-sync ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp"
                    destination:
                      port: "520"
                    source:
                      group:
                        address_group: "PEER-v4"
                  - number: 10
                    description: "Allow DNS ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp_udp"
                    state:
                      new: true
                    destination:
                      group:
                        port_group: "DNS"
              - name: "LOCAL-from-SERVICE82-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
                  - number: 10
                    description: "Allow DNS ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp_udp"
                    state:
                      new: true
                    destination:
                      group:
                        port_group: "DNS"
              - name: "LOCAL-from-SYNC-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
                  - number: 10
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    protocol: "vrrp"
                    source:
                      address: "10.9.0.{{ vyos__peer_host_id_ipv4 }}"
                  - number: 20
                    description: "Allow conntrack-sync ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "udp"
                    destination:
                      port: "3780"
                    source:
                      address: "10.9.0.{{ vyos__peer_host_id_ipv4 }}"
              - name: "LOCAL-from-UNIFI-MAN-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
                  - number: 4
                    description: "Allow DHCP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "udp"
                    source:
                      port: "68"
                    destination:
                      port: "67"
                  - number: 5
                    description: "Allow dhcp-sync ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp"
                    destination:
                      port: "520"
                    source:
                      group:
                        address_group: "PEER-v4"
                  - number: 10
                    description: "Allow DNS ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp_udp"
                    state:
                      new: true
                    destination:
                      group:
                        port_group: "DNS"
                  - number: 50
                    description: "Drop broadcast traffic ({{ ansible_managed }})"
                    action: "drop"
                    destination:
                      address: "255.255.255.255"
              - name: "LOCAL-from-WAN-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
              - name: "MAN-from-HOME-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
                  - number: 20
                    description: "Allow specific hosts ({{ ansible_managed }})"
                    action: "accept"
                    state:
                      new: true
                    source:
                      group:
                        address_group: "MAN-TALKERS-from-HOME-v4"
                  - number: 40
                    description: "Allow Zabbix Server Connections ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp"
                    state:
                      new: true
                    destination:
                      port: "10050"
                    source:
                      group:
                        address_group: "ZABBIX-SERVER-v4"
              - name: "MAN-from-LOCAL-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    protocol: "vrrp"
                  - number: 500
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "MAN-from-WAN-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
              - name: "NOWAN-from-HOME-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 20
                    description: "Allow specific hosts ({{ ansible_managed }})"
                    action: "accept"
                    state:
                      new: true
                    source:
                      group:
                        address_group: "NOWAN-TALKERS-from-HOME-v4"
              - name: "NOWAN-from-LOCAL-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    protocol: "vrrp"
                  - number: 500
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "SERVICE82-from-HOME-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      address: "10.82.0.2"
                      group:
                        port_group: "UNIFI-WEB-TCP"
                    protocol: "tcp"
              - name: "SERVICE82-from-LOCAL-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    protocol: "vrrp"
                  - number: 500
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "SERVICE82-from-UNIFI-MAN-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      address: "10.82.0.2"
                      group:
                        port_group: "UNIFI-DEVICE-TCP"
                    protocol: "tcp"
                  - number: 11
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      address: "10.82.0.2"
                      group:
                        port_group: "UNIFI-DEVICE-UDP"
                    protocol: "udp"
              - name: "SERVICE82-from-WAN-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      address: "10.82.0.2"
                      group:
                        port_group: "UNIFI-DEVICE-TCP"
                    protocol: "tcp"
                  - number: 11
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      address: "10.82.0.2"
                      group:
                        port_group: "UNIFI-DEVICE-UDP"
                    protocol: "udp"
                  - number: 12
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      address: "10.82.0.2"
                      group:
                        port_group: "UNIFI-WEB-TCP"
                    protocol: "tcp"
              - name: "SYNC-from-LOCAL-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
                  - number: 10
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    protocol: "vrrp"
                    destination:
                      address: "10.9.0.{{ vyos__peer_host_id_ipv4 }}"
                  - number: 20
                    description: "Allow conntrack-sync ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "udp"
                    destination:
                      address: "10.9.0.{{ vyos__peer_host_id_ipv4 }}"
                      port: "3780"
                  - number: 30
                    description: "Allow dhcp-sync ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp"
                    destination:
                      address: "10.9.0.{{ vyos__peer_host_id_ipv4 }}"
                      port: "520"
              - name: "UNIFI-MAN-from-HOME-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
              - name: "UNIFI-MAN-from-LOCAL-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    protocol: "vrrp"
                  - number: 500
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "UNIFI-MAN-from-SERVICE82-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
              - name: "UNIFI-MAN-from-WAN-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
              - name: "WAN-from-GUEST-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
                  - number: 5
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "WAN-from-GWORK-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
                  - number: 5
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "WAN-from-HOME-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 5
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "WAN-from-IOT-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
                  - number: 5
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "WAN-from-LOCAL-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
                  - number: 10
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    protocol: "vrrp"
                  - number: 500
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "WAN-from-MAN-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
                  - number: 5
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "WAN-from-SERVICE82-v4"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
                  - number: 5
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
          - afi: "ipv6"
            rule_sets:
              - name: "HOME-from-LOCAL-v6"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmpv6"
                  - number: 10
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    protocol: "vrrp"
                  - number: 500
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "HOME-from-MAN-v6"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmpv6"
                  - number: 20
                    description: "Allow NTP ({{ ansible_managed }})"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      group:
                        address_group: "NTP-SERVICES-v6"
                        port_group: "NTP"
                  - number: 30
                    description: "Allow ARA Connections ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp"
                    state:
                      new: true
                    destination:
                      address: "fd36:3eb3:43b0:75::1e"
                      port: "8000"
                  - number: 40
                    description: "Allow zabbix-agent Connections ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp"
                    state:
                      new: true
                    destination:
                      group:
                        address_group: "ZABBIX-SERVER-v6"
                      port: "10051"
              - name: "HOME-from-UNIFI-MAN-v6"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 20
                    description: "Allow NTP ({{ ansible_managed }})"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      group:
                        address_group: "NTP-SERVICES-v6"
                        port_group: "NTP"
              - name: "LOCAL-from-HOME-v6"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmpv6"
                  - number: 10
                    description: "Allow DNS ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp_udp"
                    state:
                      new: true
                    destination:
                      group:
                        port_group: "DNS"
              - name: "LOCAL-from-MAN-v6"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmpv6"
                  - number: 10
                    description: "Allow DNS ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp_udp"
                    state:
                      new: true
                    destination:
                      group:
                        port_group: "DNS"
              - name: "LOCAL-from-UNIFI-MAN-v6"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmpv6"
                  - number: 50
                    description: "Drop link-local multicast traffic ({{ ansible_managed }})"
                    action: "drop"
                    destination:
                      address: "ff02::1"
                  - number: 10
                    description: "Allow DNS ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp_udp"
                    state:
                      new: true
                    destination:
                      group:
                        port_group: "DNS"
              - name: "MAN-from-HOME-v6"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmpv6"
                  - number: 20
                    description: "Allow specific hosts ({{ ansible_managed }})"
                    action: "accept"
                    state:
                      new: true
                    source:
                      group:
                        address_group: "MAN-TALKERS-from-HOME-v6"
                  - number: 40
                    description: "Allow Zabbix Server Connections ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "tcp"
                    state:
                      new: true
                    destination:
                      port: "10050"
                    source:
                      group:
                        address_group: "ZABBIX-SERVER-v6"
              - name: "MAN-from-LOCAL-v6"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmpv6"
                  - number: 10
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    protocol: "vrrp"
                  - number: 500
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "UNIFI-MAN-from-HOME-v6"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
              - name: "UNIFI-MAN-from-LOCAL-v6"
                description: "{{ ansible_managed }}"
                enable_default_log: yes
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 3
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmpv6"
                  - number: 10
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    protocol: "vrrp"
                  - number: 500
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
        state: replaced
      tags:
        - firewall
        - firewall-rules
    - name: "Set Zone Policy"
      vyos.vyos.vyos_config:
        lines:
          # GUEST Zone
          - "set zone-policy zone GUEST default-action drop"
          - "set zone-policy zone GUEST description 'guest network ({{ ansible_managed }})'"
          - "set zone-policy zone GUEST from LOCAL firewall name GUEST-from-LOCAL-v4"
          - "set zone-policy zone GUEST from WAN-Cellular firewall name GUEST-from-WAN-v4"
          - "set zone-policy zone GUEST from WAN-CenturyLink firewall name GUEST-from-WAN-v4"
          - "set zone-policy zone GUEST interface {{ vyos__lan_interface }}.131"
          # GWORK Zone
          - "set zone-policy zone GWORK default-action drop"
          - "set zone-policy zone GWORK description 'work network ({{ ansible_managed }})'"
          - "set zone-policy zone GWORK from LOCAL firewall name GWORK-from-LOCAL-v4"
          - "set zone-policy zone GWORK from WAN-Cellular firewall name GWORK-from-WAN-v4"
          - "set zone-policy zone GWORK from WAN-CenturyLink firewall name GWORK-from-WAN-v4"
          - "set zone-policy zone GWORK interface {{ vyos__lan_interface }}.15"
          # HOME Zone
          - "set zone-policy zone HOME default-action drop"
          - "set zone-policy zone HOME description 'home network with home services ({{ ansible_managed }})'"
          - "set zone-policy zone HOME from IOT firewall name HOME-from-IOT-v4"
          - "set zone-policy zone HOME from LOCAL firewall name HOME-from-LOCAL-v4"
          - "set zone-policy zone HOME from LOCAL firewall ipv6-name HOME-from-LOCAL-v6"
          - "set zone-policy zone HOME from MAN firewall name HOME-from-MAN-v4"
          - "set zone-policy zone HOME from MAN firewall ipv6-name HOME-from-MAN-v6"
          - "set zone-policy zone HOME from NOWAN firewall name HOME-from-NOWAN-v4"
          - "set zone-policy zone HOME from SERVICE82 firewall name HOME-from-SERVICE82-v4"
          - "set zone-policy zone HOME from UNIFI-MAN firewall name HOME-from-UNIFI-MAN-v4"
          - "set zone-policy zone HOME from UNIFI-MAN firewall ipv6-name HOME-from-UNIFI-MAN-v6"
          - "set zone-policy zone HOME from WAN-Cellular firewall name HOME-from-WAN-v4"
          - "set zone-policy zone HOME from WAN-CenturyLink firewall name HOME-from-WAN-v4"
          - "set zone-policy zone HOME interface {{ vyos__lan_interface }}.117"
          # IOT Zone
          - "set zone-policy zone IOT default-action drop"
          - "set zone-policy zone IOT description 'IoT network ({{ ansible_managed }})'"
          - "set zone-policy zone IOT from HOME firewall name IOT-from-HOME-v4"
          - "set zone-policy zone IOT from LOCAL firewall name IOT-from-LOCAL-v4"
          - "set zone-policy zone IOT from WAN-Cellular firewall name IOT-from-WAN-v4"
          - "set zone-policy zone IOT from WAN-CenturyLink firewall name IOT-from-WAN-v4"
          - "set zone-policy zone IOT interface {{ vyos__lan_interface }}.66"
          # LOCAL Zone
          - "set zone-policy zone LOCAL default-action drop"
          - "set zone-policy zone LOCAL description '{{ ansible_managed }}'"
          - "set zone-policy zone LOCAL from GUEST firewall name LOCAL-from-GUEST-v4"
          - "set zone-policy zone LOCAL from GWORK firewall name LOCAL-from-GWORK-v4"
          - "set zone-policy zone LOCAL from HOME firewall name LOCAL-from-HOME-v4"
          - "set zone-policy zone LOCAL from HOME firewall ipv6-name LOCAL-from-HOME-v6"
          - "set zone-policy zone LOCAL from IOT firewall name LOCAL-from-IOT-v4"
          - "set zone-policy zone LOCAL from MAN firewall name LOCAL-from-MAN-v4"
          - "set zone-policy zone LOCAL from MAN firewall ipv6-name LOCAL-from-MAN-v6"
          - "set zone-policy zone LOCAL from NOWAN firewall name LOCAL-from-NOWAN-v4"
          - "set zone-policy zone LOCAL from UNIFI-MAN firewall name LOCAL-from-UNIFI-MAN-v4"
          - "set zone-policy zone LOCAL from UNIFI-MAN firewall ipv6-name LOCAL-from-UNIFI-MAN-v6"
          - "set zone-policy zone LOCAL from SERVICE82 firewall name LOCAL-from-SERVICE82-v4"
          - "set zone-policy zone LOCAL from SYNC firewall name LOCAL-from-SYNC-v4"
          - "set zone-policy zone LOCAL from WAN-Cellular firewall name LOCAL-from-WAN-v4"
          - "set zone-policy zone LOCAL from WAN-CenturyLink firewall name LOCAL-from-WAN-v4"
          - "set zone-policy zone LOCAL local-zone"
          # MAN Zone
          - "set zone-policy zone MAN default-action drop"
          - "set zone-policy zone MAN description 'management vlan ({{ ansible_managed }})'"
          - "set zone-policy zone MAN from HOME firewall name MAN-from-HOME-v4"
          - "set zone-policy zone MAN from HOME firewall ipv6-name MAN-from-HOME-v6"
          - "set zone-policy zone MAN from LOCAL firewall name MAN-from-LOCAL-v4"
          - "set zone-policy zone MAN from LOCAL firewall ipv6-name MAN-from-LOCAL-v6"
          - "set zone-policy zone MAN from WAN-Cellular firewall name MAN-from-WAN-v4"
          - "set zone-policy zone MAN from WAN-CenturyLink firewall name MAN-from-WAN-v4"
          - "set zone-policy zone MAN interface {{ vyos__lan_interface }}.10"
          # NOWAN Zone
          - "set zone-policy zone NOWAN default-action drop"
          - "set zone-policy zone NOWAN description 'internet of shit: no WAN or other access ({{ ansible_managed }})'"
          - "set zone-policy zone NOWAN from HOME firewall name NOWAN-from-HOME-v4"
          - "set zone-policy zone NOWAN from LOCAL firewall name NOWAN-from-LOCAL-v4"
          - "set zone-policy zone NOWAN interface {{ vyos__lan_interface }}.67"
          # SERVICE82 Zone
          - "set zone-policy zone SERVICE82 default-action drop"
          - "set zone-policy zone SERVICE82 description 'installation02 - unifi controller ({{ ansible_managed }})'"
          - "set zone-policy zone SERVICE82 from HOME firewall name SERVICE82-from-HOME-v4"
          - "set zone-policy zone SERVICE82 from LOCAL firewall name SERVICE82-from-LOCAL-v4"
          - "set zone-policy zone SERVICE82 from UNIFI-MAN firewall name SERVICE82-from-UNIFI-MAN-v4"
          - "set zone-policy zone SERVICE82 from WAN-Cellular firewall name SERVICE82-from-WAN-v4"
          - "set zone-policy zone SERVICE82 from WAN-CenturyLink firewall name SERVICE82-from-WAN-v4"
          - "set zone-policy zone SERVICE82 interface {{ vyos__lan_interface }}.82"
          # SYNC Zone
          - "set zone-policy zone SYNC default-action drop"
          - "set zone-policy zone SYNC description 'VRRP and other related synchronizations connection ({{ ansible_managed }})'"
          - "set zone-policy zone SYNC from LOCAL firewall name SYNC-from-LOCAL-v4"
          - "set zone-policy zone SYNC interface {{ vyos__lan_interface }}.9"
          # UNIFI-MAN Zone
          - "set zone-policy zone UNIFI-MAN default-action drop"
          - "set zone-policy zone UNIFI-MAN description 'unifi management vlan ({{ ansible_managed }})'"
          - "set zone-policy zone UNIFI-MAN from HOME firewall name UNIFI-MAN-from-HOME-v4"
          - "set zone-policy zone UNIFI-MAN from HOME firewall ipv6-name UNIFI-MAN-from-HOME-v6"
          - "set zone-policy zone UNIFI-MAN from LOCAL firewall name UNIFI-MAN-from-LOCAL-v4"
          - "set zone-policy zone UNIFI-MAN from LOCAL firewall ipv6-name UNIFI-MAN-from-LOCAL-v6"
          - "set zone-policy zone UNIFI-MAN from SERVICE82 firewall name UNIFI-MAN-from-SERVICE82-v4"
          - "set zone-policy zone UNIFI-MAN from WAN-Cellular firewall name UNIFI-MAN-from-WAN-v4"
          - "set zone-policy zone UNIFI-MAN from WAN-CenturyLink firewall name UNIFI-MAN-from-WAN-v4"
          - "set zone-policy zone UNIFI-MAN interface {{ vyos__lan_interface }}"
          # WAN-Cellular Zone
          - "set zone-policy zone WAN-Cellular default-action drop"
          - "set zone-policy zone WAN-Cellular description 'Cellular WAN connection ({{ ansible_managed }})'"
          - "set zone-policy zone WAN-Cellular from GUEST firewall name WAN-from-GUEST-v4"
          - "set zone-policy zone WAN-Cellular from GWORK firewall name WAN-from-GWORK-v4"
          - "set zone-policy zone WAN-Cellular from HOME firewall name WAN-from-HOME-v4"
          - "set zone-policy zone WAN-Cellular from IOT firewall name WAN-from-IOT-v4"
          - "set zone-policy zone WAN-Cellular from LOCAL firewall name WAN-from-LOCAL-v4"
          - "set zone-policy zone WAN-Cellular from MAN firewall name WAN-from-MAN-v4"
          - "set zone-policy zone WAN-Cellular from SERVICE82 firewall name WAN-from-SERVICE82-v4"
          - "set zone-policy zone WAN-Cellular interface {{ vyos__wan_cellular_interface }}"
          # WAN-CenturyLink Zone
          - "set zone-policy zone WAN-CenturyLink default-action drop"
          - "set zone-policy zone WAN-CenturyLink description 'CenturyLink WAN connection ({{ ansible_managed }})'"
          - "set zone-policy zone WAN-CenturyLink from GUEST firewall name WAN-from-GUEST-v4"
          - "set zone-policy zone WAN-CenturyLink from GWORK firewall name WAN-from-GWORK-v4"
          - "set zone-policy zone WAN-CenturyLink from HOME firewall name WAN-from-HOME-v4"
          - "set zone-policy zone WAN-CenturyLink from IOT firewall name WAN-from-IOT-v4"
          - "set zone-policy zone WAN-CenturyLink from LOCAL firewall name WAN-from-LOCAL-v4"
          - "set zone-policy zone WAN-CenturyLink from MAN firewall name WAN-from-MAN-v4"
          - "set zone-policy zone WAN-CenturyLink from SERVICE82 firewall name WAN-from-SERVICE82-v4"
          - "set zone-policy zone WAN-CenturyLink interface pppoe0"
        save: yes
      tags:
        - firewall

    #
    # Failover
    #
    - name: "Setup WAN load-balancing"
      vyos.vyos.vyos_config:
        lines:
          - "set load-balancing wan interface-health pppoe0 nexthop dhcp"
          - "set load-balancing wan interface-health pppoe0 failure-count 2"
          - "set protocols static interface-route 0.0.0.0/0 next-hop-interface pppoe0 distance 10"
          - "set load-balancing wan interface-health {{ vyos__wan_cellular_interface }} nexthop 172.16.5.1"
          - "set load-balancing wan interface-health {{ vyos__wan_cellular_interface }} failure-count 5"
          - "set protocols static route 0.0.0.0/0 next-hop 172.16.5.1 distance 100"
      tags:
        - failover
    - name: "Setup static routes and ping targets for WAN-CenturyLink"
      vyos.vyos.vyos_config:
        lines:
          - "set protocols static interface-route {{ item }}/32 next-hop-interface pppoe0"
          - "set load-balancing wan interface-health pppoe0 test {{ rule_number }} type ping"
          - "set load-balancing wan interface-health pppoe0 test {{ rule_number }} target {{ item }}"
      loop: "{{ vyos__wan_centurylink_dns }}"
      loop_control:
        index_var: rule_number
      tags:
        - failover
    - name: "Setup static routes and ping targets for WAN-Cellular"
      vyos.vyos.vyos_config:
        lines:
          - "set protocols static route {{ item }}/32 next-hop 172.16.5.1"
          - "set load-balancing wan interface-health {{ vyos__wan_cellular_interface }} test {{ rule_number }} type ping"
          - "set load-balancing wan interface-health {{ vyos__wan_cellular_interface }} test {{ rule_number }} target {{ item }}"
      loop: "{{ vyos__wan_cellular_dns }}"
      loop_control:
        index_var: rule_number
      tags:
        - failover
    - name: "Setup rules for each inbound interface"
      vyos.vyos.vyos_config:
        lines:
          # Exclude Private IPv4 Space
          - "set load-balancing wan rule {{ ((rule_number + 1) * 10) + 3 }} destination address 10.0.0.0/8"
          - "set load-balancing wan rule {{ ((rule_number + 1) * 10) + 3 }} exclude"
          - "set load-balancing wan rule {{ ((rule_number + 1) * 10) + 3 }} inbound-interface {{ item.interface }}"
          - "set load-balancing wan rule {{ ((rule_number + 1) * 10) + 4 }} destination address 172.16.0.0/12"
          - "set load-balancing wan rule {{ ((rule_number + 1) * 10) + 4 }} exclude"
          - "set load-balancing wan rule {{ ((rule_number + 1) * 10) + 4 }} inbound-interface {{ item.interface }}"
          - "set load-balancing wan rule {{ ((rule_number + 1) * 10) + 5 }} destination address 192.168.0.0/16"
          - "set load-balancing wan rule {{ ((rule_number + 1) * 10) + 5 }} exclude"
          - "set load-balancing wan rule {{ ((rule_number + 1) * 10) + 5 }} inbound-interface {{ item.interface }}"
          # Setup Failover
          - "set load-balancing wan rule {{ ((rule_number + 1) * 10) + 9 }} failover"
          - "set load-balancing wan rule {{ ((rule_number + 1) * 10) + 9 }} inbound-interface {{ item.interface }}"
          - "set load-balancing wan rule {{ ((rule_number + 1) * 10) + 9 }} interface pppoe0 weight 10"
          - "set load-balancing wan rule {{ ((rule_number + 1) * 10) + 9 }} interface {{ vyos__wan_cellular_interface }} weight 1"
        save: yes
      loop: "{{ lan_interfaces_with_wan_access }}"
      loop_control:
        index_var: rule_number
        label: "{{ item.interface }}"
      tags:
        - rules
        - failover

    #
    # NAT
    #
    - name: "Setup NAT masquerade rules"
      vyos.vyos.vyos_config:
        lines:
          - "set nat source rule {{ (rule_number + 1) * 10 }} outbound-interface pppoe0"
          - "set nat source rule {{ (rule_number + 1) * 10 }} source address {{ item.ipv4_network }}"
          - "set nat source rule {{ (rule_number + 1) * 10 }} translation address masquerade"
          - "set nat source rule {{ ((rule_number + 1) * 10) + 1 }} outbound-interface {{ vyos__wan_cellular_interface }}"
          - "set nat source rule {{ ((rule_number + 1) * 10) + 1 }} source address {{ item.ipv4_network }}"
          - "set nat source rule {{ ((rule_number + 1) * 10) + 1 }} translation address masquerade"
      loop: "{{ lan_interfaces_with_wan_access }}"
      loop_control:
        index_var: rule_number
      tags:
        - nat
    - name: "Setup port forwarding rules"
      vyos.vyos.vyos_config:
        lines:
          - "set nat destination rule {{ (rule_number + 1) * 10 }} description '{{ item.description }} ({{ ansible_managed }})'"
          - "set nat destination rule {{ (rule_number + 1) * 10 }} destination port '{{ item.port }}'"
          - "set nat destination rule {{ (rule_number + 1) * 10 }} inbound-interface pppoe0"
          - "set nat destination rule {{ (rule_number + 1) * 10 }} protocol '{{ item.protocol }}'"
          - "set nat destination rule {{ (rule_number + 1) * 10 }} translation address '{{ item.translation_address }}'"
          - "set nat destination rule {{ ((rule_number + 1) * 10) + 1 }} description '{{ item.description }} ({{ ansible_managed }})'"
          - "set nat destination rule {{ ((rule_number + 1) * 10) + 1 }} destination port '{{ item.port }}'"
          - "set nat destination rule {{ ((rule_number + 1) * 10) + 1 }} inbound-interface {{ vyos__wan_cellular_interface }}"
          - "set nat destination rule {{ ((rule_number + 1) * 10) + 1 }} protocol '{{ item.protocol }}'"
          - "set nat destination rule {{ ((rule_number + 1) * 10) + 1 }} translation address '{{ item.translation_address }}'"
      loop:
        - description: "factorio-server"
          port: "34197"
          protocol: "udp"
          translation_address: "10.117.0.30"
        - description: "valheim-server"
          port: "2456-2458"
          protocol: "udp"
          translation_address: "10.117.0.30"
        - description: "unifi-gui"
          port: "8443"
          protocol: "tcp"
          translation_address: "10.82.0.2"
        - description: "unifi-inform"
          port: "8080"
          protocol: "tcp"
          translation_address: "10.82.0.2"
        - description: "unifi-ssh"
          port: "4222"
          protocol: "tcp"
          translation_address: "10.82.0.2"
        - description: "unifi-stun"
          port: "3478"
          protocol: "udp"
          translation_address: "10.82.0.2"
      loop_control:
        index_var: rule_number
      tags:
        - nat

    #
    # Services
    #
    - name: "Setup connection-tracking synchronization"
      vyos.vyos.vyos_config:
        lines:
          # Configure Conntrack
          - "set system conntrack modules ftp disable"
          - "set system conntrack modules h323 disable"
          - "set system conntrack modules nfs disable"
          - "set system conntrack modules pptp disable"
          - "set system conntrack modules sip disable"
          - "set system conntrack modules sqlnet disable"
          - "set system conntrack modules tftp disable"
          # Configure Synchronization
          - "set service conntrack-sync accept-protocol 'tcp,udp,icmp'"
          - "set service conntrack-sync event-listen-queue-size 8"
          - "set service conntrack-sync failover-mechanism vrrp sync-group MAIN"
          - "set service conntrack-sync interface {{ vyos__lan_interface }}.9 peer 10.9.0.{{ vyos__peer_host_id_ipv4 }}"
          - "set service conntrack-sync sync-queue-size 8"
        save: yes
      tags:
        - services
        - conntrack
    - name: "Setup SSH"
      vyos.vyos.vyos_config:
        lines:
          - "set service ssh port 22"
          - "set service ssh listen-address 10.10.0.{{ vyos__host_id_ipv4 }}"
          - "set service ssh listen-address fd36:3eb3:43b0:a::{{ vyos__host_id_ipv6 }}"
          - "set service ssh disable-password-authentication"
          - "set system login user ansible full-name 'ansible'"
          - "set system login user ansible authentication public-keys 'sdwilsh-dev' key '{{ common__ansible_key }}'"
          - "set system login user ansible authentication public-keys 'sdwilsh-dev' type '{{ common__ansible_key_type }}'"
        save: yes
      tags:
        - services
        - ssh

    - ansible.builtin.set_fact:
        dhcp_servers:
          - name: "UNIFI-MAN"
            default_router: "10.1.0.1"
            own_dns: true
            range:
              start: "10.1.0.150"
              stop: "10.1.0.250"
            subnet: "10.1.0.0/24"
          - name: "MAN"
            default_router: "10.10.0.1"
            own_dns: true
            range:
              start: "10.10.0.200"
              stop: "10.10.0.250"
            subnet: "10.10.0.0/24"
          - name: "GWORK"
            default_router: "192.168.1.1"
            own_dns: true
            range:
              start: "192.168.1.100"
              stop: "192.168.1.250"
            subnet: "192.168.1.0/24"
          - name: "IOT"
            default_router: "10.66.0.1"
            own_dns: true
            range:
              start: "10.66.0.10"
              stop: "10.66.0.250"
            subnet: "10.66.0.0/24"
          - name: "NOWAN"
            default_router: "10.67.0.1"
            own_dns: true
            range:
              start: "10.67.0.10"
              stop: "10.67.0.250"
            subnet: "10.67.0.0/24"
          - name: "HOME"
            default_router: "10.117.0.1"
            own_dns: true
            range:
              start: "10.117.1.1"
              stop: "10.117.1.254"
            static_mapping:
              - name: "office-printer"
                ip: "10.117.0.14"
                mac: "f8:0d:60:ca:32:bf"
              - name: "lutron"
                ip: "10.117.0.18"
                mac: "50:8c:b1:1d:4d:1f"
              - name: "roku-master"
                ip: "10.117.0.20"
                mac: "d8:31:34:5f:6c:35"
              - name: "roku-den"
                ip: "10.117.0.21"
                mac: "d8:31:34:66:95:f1"
            subnet: "10.117.0.0/23"
          - name: "GUEST"
            default_router: "10.131.0.1"
            own_dns: false
            range:
              start: "10.131.0.100"
              stop: "10.131.0.250"
            subnet: "10.131.0.0/24"
      tags:
        - always
    - name: "Setup DHCP"
      vyos.vyos.vyos_config:
        lines:
          - "set service dhcp-server shared-network-name {{ item.name }} authoritative"
          - "set service dhcp-server shared-network-name {{ item.name }} subnet {{ item.subnet }} default-router {{ item.default_router }}"
          - "set service dhcp-server shared-network-name {{ item.name }} subnet {{ item.subnet }} range 0 start {{ item.range.start }}"
          - "set service dhcp-server shared-network-name {{ item.name }} subnet {{ item.subnet }} range 0 stop {{ item.range.stop }}"
          - "set service dhcp-server shared-network-name {{ item.name }} subnet {{ item.subnet }} failover local-address {{ item.default_router[:-1] }}{{ vyos__host_id_ipv4 }}"
          - "set service dhcp-server shared-network-name {{ item.name }} subnet {{ item.subnet }} failover peer-address {{ item.default_router[:-1] }}{{ vyos__peer_host_id_ipv4 }}"
          - "set service dhcp-server shared-network-name {{ item.name }} subnet {{ item.subnet }} failover name {{ item.name }}-HA"
          - "set service dhcp-server shared-network-name {{ item.name }} subnet {{ item.subnet }} failover status {% if vyos__vrrp_priority < 100 %}secondary{% else %}primary{% endif %}"
      loop: "{{ dhcp_servers }}"
      loop_control:
        label: "{{ item.name }} ({{ item.subnet }})"
      tags:
        - services
        - dhcp-server
    - name: "Setup DHCP DNS Servers"
      vyos.vyos.vyos_config:
        lines:
          - >-
            set service dhcp-server shared-network-name {{ item.name }} subnet {{ item.subnet }} dns-server
            {{ item.default_router[:-1] }}1
          - >-
            set service dhcp-server shared-network-name {{ item.name }} subnet {{ item.subnet }} dns-server
            {{ item.default_router[:-1] }}{{ vyos__host_id_ipv4 }}
          - >-
            set service dhcp-server shared-network-name {{ item.name }} subnet {{ item.subnet }} dns-server
            {{ item.default_router[:-1] }}{{ vyos__peer_host_id_ipv4 }}
      loop: "{{ dhcp_servers }}"
      loop_control:
        label: "{{ item.name }} ({{ item.subnet }})"
      when: "item.own_dns"
      tags:
        - services
        - dhcp-server
    - name: "Setup DHCP DNS Servers"
      vyos.vyos.vyos_config:
        lines:
          - "set service dhcp-server shared-network-name {{ item.name }} subnet {{ item.subnet }} dns-server 1.1.1.2"
          - "set service dhcp-server shared-network-name {{ item.name }} subnet {{ item.subnet }} dns-server 1.0.0.2"
      loop: "{{ dhcp_servers }}"
      loop_control:
        label: "{{ item.name }} ({{ item.subnet }})"
      when: "not item.own_dns"
      tags:
        - services
        - dhcp-server
    - name: "Setup DHCP Static Assignments"
      vyos.vyos.vyos_config:
        lines:
          - "set service dhcp-server shared-network-name {{ item.0.name }} subnet {{ item.0.subnet }} static-mapping {{ item.1.name }} mac-address {{ item.1.mac }}"
          - "set service dhcp-server shared-network-name {{ item.0.name }} subnet {{ item.0.subnet }} static-mapping {{ item.1.name }} ip-address {{ item.1.ip }}"
      loop: "{{ dhcp_servers | subelements('static_mapping', skip_missing=true) }}"
      loop_control:
        label: "{{ item.0.name }}: {{ item.1.name }} ({{ item.1.ip }})"
      tags:
        - services
        - dhcp-server
    - name: "Setup UBNT DHCP global-parameters"
      vyos.vyos.vyos_config:
        lines:
          - "set service dhcp-server global-parameters 'option space ubnt;'"
          - "set service dhcp-server global-parameters 'option ubnt.unifi-address code 1 = ip-address;'"
          - "set service dhcp-server global-parameters 'class &quot;ubnt&quot; { match if substring (option vendor-class-identifier, 0, 4) = &quot;ubnt&quot;; option vendor-class-identifier &quot;ubnt&quot;; vendor-option-space ubnt; }'"
          - "set service dhcp-server shared-network-name UNIFI-MAN subnet 10.1.0.0/24 subnet-parameters 'option ubnt.unifi-address 10.82.0.2;'"
        save: yes
      tags:
        - services
        - dhcp-server

    - name: "Setup DNS Forwarding"
      vyos.vyos.vyos_config:
        lines:
          - "set service dns forwarding allow-from 127.0.0.0/8"
          - "set service dns forwarding allow-from ::1/128"
          - "set service dns forwarding allow-from 10.0.0.0/8"
          - "set service dns forwarding allow-from 192.168.1.0/24"
          - "set service dns forwarding allow-from fd00::/8"
          - "set service dns forwarding domain 0.10.10.in-addr.arpa server 10.10.0.3"
          - "set service dns forwarding domain 0.117.10.in-addr.arpa server 10.10.0.3"
          - "set service dns forwarding domain 5.7.0.0.0.b.3.4.3.b.e.3.6.3.d.f.ip6.arpa server 10.10.0.3"
          - "set service dns forwarding domain a.0.0.0.0.b.3.4.3.b.e.3.6.3.d.f.ip6.arpa server 10.10.0.3"
          - "set service dns forwarding domain tswn.us server 10.10.0.3"
          - "set service dns forwarding domain tswn.us server fd36:3eb3:43b0:a::3"
          - "set service dns forwarding name-server 1.1.1.2"
          - "set service dns forwarding name-server 1.0.0.2"
        save: yes
      tags:
        - services
        - dns
    - name: "Set DNS Listenting Addresses"
      vyos.vyos.vyos_config:
        lines:
          - "set service dns forwarding listen-address {{ item }}"
        save: yes
      loop:
          # localhost
          - "127.0.0.1"
          # UNIFI-MAN
          - "10.1.0.1"
          - "10.1.0.{{ vyos__host_id_ipv4 }}"
          - "fd36:3eb3:43b0:1::{{ vyos__host_id_ipv6 }}"
          # MAN
          - "10.10.0.1"
          - "10.10.0.{{ vyos__host_id_ipv4 }}"
          - "fd36:3eb3:43b0:a::{{ vyos__host_id_ipv6 }}"
          # GWORK
          - "10.15.0.1"
          - "10.15.0.{{ vyos__host_id_ipv4 }}"
          # IOT
          - "10.66.0.1"
          - "10.66.0.{{ vyos__host_id_ipv4 }}"
          # NOWAN
          - "10.67.0.1"
          - "10.67.0.{{ vyos__host_id_ipv4 }}"
          # SERVICE82
          - "10.82.0.1"
          - "10.82.0.{{ vyos__host_id_ipv4 }}"
          # ROUTER-LAB
          - "10.100.0.1"
          - "10.100.0.{{ vyos__host_id_ipv4 }}"
          # HOME
          - "10.117.0.1"
          - "10.117.0.{{ vyos__host_id_ipv4 }}"
          - "fd36:3eb3:43b0:75::{{ vyos__host_id_ipv6 }}"
      tags:
        - services
        - dns

    - name: "Setup Router Advertisement"
      vyos.vyos.vyos_config:
        lines:
          # UNIFI-MAN
          - "set service router-advert interface {{ vyos__lan_interface }} prefix fd36:3eb3:43b0:1::/64 valid-lifetime 172800"
          - "set service router-advert interface {{ vyos__lan_interface }} name-server fd36:3eb3:43b0:1::{{ vyos__host_id_ipv6 }}"
          - "set service router-advert interface {{ vyos__lan_interface }} name-server fd36:3eb3:43b0:1::{{ vyos__peer_host_id_ipv6 }}"
          # MAN
          - "set service router-advert interface {{ vyos__lan_interface }}.10 no-send-advert"
          - "set service router-advert interface {{ vyos__lan_interface }}.10 prefix fd36:3eb3:43b0:a::/64 valid-lifetime 172800"
          - "set service router-advert interface {{ vyos__lan_interface }}.10 prefix fd36:3eb3:43b0:a::/64 no-autonomous-flag"
          - "set service router-advert interface {{ vyos__lan_interface }}.10 name-server fd36:3eb3:43b0:a::{{ vyos__host_id_ipv6 }}"
          - "set service router-advert interface {{ vyos__lan_interface }}.10 name-server fd36:3eb3:43b0:a::{{ vyos__peer_host_id_ipv6 }}"
          # HOME
          - "set service router-advert interface {{ vyos__lan_interface }}.117 no-send-advert"
          - "set service router-advert interface {{ vyos__lan_interface }}.117 prefix fd36:3eb3:43b0:75::/64 valid-lifetime 172800"
          - "set service router-advert interface {{ vyos__lan_interface }}.117 prefix fd36:3eb3:43b0:75::/64 no-autonomous-flag"
          - "set service router-advert interface {{ vyos__lan_interface }}.117 name-server fd36:3eb3:43b0:75::{{ vyos__host_id_ipv6 }}"
          - "set service router-advert interface {{ vyos__lan_interface }}.117 name-server fd36:3eb3:43b0:75::{{ vyos__peer_host_id_ipv6 }}"
        save: yes
      tags:
        - services
        - router-advert
