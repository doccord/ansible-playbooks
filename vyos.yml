---
- hosts: vyos
  gather_facts: false
  tasks:
    # TODO: v6 firewall rules
    # TODO: add NAT
    # TODO: setup failover
    - name: "Gather Config"
      vyos.vyos.vyos_facts:
        gather_subset: "config"

    #
    # System
    #
    - name: "Set hostname"
      vyos.vyos.vyos_system:
        host_name: "{{ inventory_hostname }}"
        state: "present"
    - name: "Set nameservers"
      vyos.vyos.vyos_system:
        name_servers: "{{ common__nameservers.addresses }}"
    - name: "Set domain search suffixes"
      vyos.vyos.vyos_system:
        domain_search: "{{ common__nameservers.search }}"
    - name: "Remove default NTP servers"
      vyos.vyos.vyos_config:
        lines:
          - "delete system ntp server {{ item }}"
      loop:
        - "0.pool.ntp.org"
        - "1.pool.ntp.org"
        - "2.pool.ntp.org"
      when: item in ansible_net_config[0]
    - name: "Remove default NTP servers"
      vyos.vyos.vyos_config:
        lines:
          - "set system ntp server {{ common__ntp_pool }} pool"
          - "set system time-zone US/Pacific"
        save: true

    #
    # Interfaces
    #
    - name: "Set the device interfaces"
      vyos.vyos.vyos_interfaces:
        config:
          - name: "{{ vyos__lan_interface }}"
            description: "Local Network ({{ ansible_managed }})"
            enabled: true
            vifs:
              - vlan_id: 1
                description: "UNIFI-MAN - management vlan for Unifi devices ({{ ansible_managed }})"
              - vlan_id: 10
                description: "MAN - management vlan ({{ ansible_managed }})"
              - vlan_id: 15
                description: "GWORK - work-friendly addressed network ({{ ansible_managed }})"
              - vlan_id: 66
                description: "IOT - internet of things: WAN access, but not much else ({{ ansible_managed }})"
              - vlan_id: 67
                description: "NOWAN - internet of shit: no WAN or other access ({{ ansible_managed }})"
              - vlan_id: 82
                description: "SERVICE82 - installation02 (unifi controller) ({{ ansible_managed }})"
              - vlan_id: 100
                description: "ROUTER-LAB - acts as a WAN for testing ({{ ansible_managed }})"
              - vlan_id: 117
                description: "HOME - home network with home services ({{ ansible_managed }})"
              - vlan_id: 131
                description: "GUEST - used for guest wifi ({{ ansible_managed }})"
          - name: "{{ vyos__wan_cellular_interface }}"
            description: "Cellular WAN ({{ ansible_managed }})"
            enabled: true
          - name: "{{ vyos__wan_centurylink_interface }}"
            description: "CenturyLink WAN ({{ ansible_managed }})"
            enabled: true
            vifs:
              - vlan_id: 201
                description: "CenturyLink PPPOE ({{ ansible_managed }})"
        state: merged
    - name: "Setup CenturyLink PPPOE"
      vyos.vyos.vyos_config:
        lines:
          - "set interfaces pppoe pppoe0 authentication password {{ vyos__wan_centurylink_password }}"
          - "set interfaces pppoe pppoe0 authentication user {{ vyos__wan_centurylink_username }}"
          - "set interfaces pppoe pppoe0 default-route auto"
          - "set interfaces pppoe pppoe0 mtu 1492"
          - "set interfaces pppoe pppoe0 no-peer-dns"
          - "set interfaces pppoe pppoe0 source-interface {{ vyos__wan_centurylink_interface }}.201"
        save: yes
    - name: "Set interfaces addresses"
      vyos.vyos.vyos_config:
        lines:
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 1 address 10.1.0.{{ vyos__host_id_ipv4 }}/24"
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 1 address fd36:3eb3:43b0:1::{{ vyos__host_id_ipv6 }}/64"
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 10 address 10.10.0.{{ vyos__host_id_ipv4 }}/24"
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 10 address fd36:3eb3:43b0:a::{{ vyos__host_id_ipv6 }}/64"
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 15 address 192.168.1.{{ vyos__host_id_ipv4 }}/24"
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 66 address 10.66.0.{{ vyos__host_id_ipv4 }}/24"
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 67 address 10.67.0.{{ vyos__host_id_ipv4 }}/24"
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 82 address 10.82.0.{{ vyos__host_id_ipv4 }}/24"
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 100 address 10.100.0.{{ vyos__host_id_ipv4 }}/24"
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 117 address 10.117.0.{{ vyos__host_id_ipv4 }}/24"
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 117 address fd36:3eb3:43b0:75::{{ vyos__host_id_ipv6 }}/64"
          - "set interfaces ethernet {{ vyos__lan_interface }} vif 131 address 10.131.0.{{ vyos__host_id_ipv4 }}/24"
          - "set interfaces ethernet {{ vyos__wan_cellular_interface }} address 172.16.5.{{ vyos__host_id_ipv4 }}/24"
        save: yes

    #
    # Firewall
    #
    - name: "Set global firewall settings"
      vyos.vyos.vyos_firewall_global:
        config:
          config_trap: no
          group:
            address_group:
              - name: "DNS-SERVICES-v4"
                description: "DNS services ({{ ansible_managed }})"
                members:
                  - address: "10.117.0.3"
                  - address: "10.117.0.4"
              - name: "DNS-SERVICES-v6"
                description: "DNS services ({{ ansible_managed }})"
                afi: "ipv6"
                members:
                  - address: "fd36:3eb3:43b0:75::3"
                  - address: "fd36:3eb3:43b0:75::4"
              - name: "NTP-SERVICES-v4"
                description: "NTP services ({{ ansible_managed }})"
                members:
                  - address: "10.117.0.50"
              - name: "NOWAN-TALKERS-from-HOME-v4"
                description: "IP Addresses allowed to talk to devices on NOWAN ({{ ansible_managed }})"
                members:
                  # cortana.hogs.tswn.us
                  - address: "10.117.0.19"
                  # sdwilsh-desktop
                  - address: "10.117.0.31"
              - name: "NOWAN-TALKERS-from-HOME-v6"
                description: "IP Addresses allowed to talk to devices on NOWAN ({{ ansible_managed }})"
                afi: "ipv6"
                members:
                  # cortana.hogs.tswn.us
                  - address: "fd36:3eb3:43b0:75::13"
                  # sdwilsh-desktop
                  - address: "fd36:3eb3:43b0:75::1f"
            network_group:
              - name: "RFC1918-v4"
                description: "IPv4 Private Address Space ({{ ansible_managed }})"
                members:
                  - address: "192.168.0.0/16"
                  - address: "172.16.0.0/12"
                  - address: "10.0.0.0/8"
            port_group:
              - name: "DNS"
                description: "{{ ansible_managed }}"
                members:
                  - port: "53"
              - name: "NTP"
                description: "{{ ansible_managed }}"
                members:
                  - port: "123"
              - name: "UNIFI-DEVICE-TCP"
                description: "Ports used by the Unifi Controller to talk to devices over TCP ({{ ansible_managed }})"
                members:
                  - port: "8080"
                  - port: "6789"
              - name: "UNIFI-DEVICE-UDP"
                description: "Ports used by the Unifi Controller to talk to devices over UDP ({{ ansible_managed }})"
                members:
                  - port: "3478"
              - name: "UNIFI-WEB-TCP"
                description: "Ports used by the Unifi Controller for clients ({{ ansible_managed }})"
                members:
                  - port: "8880"
                  - port: "8843"
          log_martians: yes
          ping:
            all: yes
            broadcast: no
          route_redirects:
            - afi: ipv4
              icmp_redirects:
                receive: no
                send: yes
              ip_src_route: no
            - afi: ipv6
              icmp_redirects:
                receive: no
                send: yes
              ip_src_route: no
          syn_cookies: yes
          twa_hazards_protection: yes
          validation: disable
        state: replaced

    - name: "Set the firewall rules"
      vyos.vyos.vyos_firewall_rules:
        config:
          - afi: "ipv4"
            rule_sets:
              - name: "GUEST-from-LOCAL-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 5
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "GUEST-from-WAN-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
              - name: "GWORK-from-LOCAL-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 5
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "GWORK-from-WAN-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
              - name: "HOME-from-IOT-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "Allow DNS ({{ ansible_managed }})"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      group:
                        address_group: "DNS-SERVICES-v4"
                        port_group: "DNS"
                  - number: 20
                    description: "Allow NTP ({{ ansible_managed }})"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      group:
                        address_group: "NTP-SERVICES-v4"
                        port_group: "NTP"
              - name: "HOME-from-LOCAL-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 5
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "HOME-from-MAN-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "Allow DNS ({{ ansible_managed }})"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      group:
                        address_group: "DNS-SERVICES-v4"
                        port_group: "DNS"
                  - number: 20
                    description: "Allow NTP ({{ ansible_managed }})"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      group:
                        address_group: "NTP-SERVICES-v4"
                        port_group: "NTP"
              - name: "HOME-from-NOWAN-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "Allow DNS ({{ ansible_managed }})"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      group:
                        address_group: "DNS-SERVICES-v4"
                        port_group: "DNS"
                  - number: 20
                    description: "Allow NTP ({{ ansible_managed }})"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      group:
                        address_group: "NTP-SERVICES-v4"
                        port_group: "NTP"
              - name: "HOME-from-SERVICE82-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "Allow DNS ({{ ansible_managed }})"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      group:
                        address_group: "DNS-SERVICES-v4"
                        port_group: "DNS"
                  - number: 20
                    description: "Allow NTP ({{ ansible_managed }})"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      group:
                        address_group: "NTP-SERVICES-v4"
                        port_group: "NTP"
              - name: "HOME-from-UNIFI-MAN-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "Allow DNS ({{ ansible_managed }})"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      group:
                        address_group: "DNS-SERVICES-v4"
                        port_group: "DNS"
                  - number: 20
                    description: "Allow NTP ({{ ansible_managed }})"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      group:
                        address_group: "NTP-SERVICES-v4"
                        port_group: "NTP"
              - name: "HOME-from-WAN-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
              - name: "IOT-from-HOME-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
              - name: "IOT-from-LOCAL-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 5
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "IOT-from-WAN-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
              - name: "LOCAL-from-HOME-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
                  - number: 20
                    description: "Allow DHCP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "udp"
                    source:
                      port: "68"
                    destination:
                      port: "67"
              - name: "LOCAL-from-MAN-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "Allow SSH ({{ ansible_managed }})"
                    action: "accept"
                    destination:
                      port: "22"
                    protocol: "tcp"
                    state:
                      new: true
              - name: "LOCAL-from-NOWAN-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
                  - number: 20
                    description: "Allow DHCP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "udp"
                    source:
                      port: "68"
                    destination:
                      port: "67"
              - name: "LOCAL-from-WAN-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "Allow ICMP ({{ ansible_managed }})"
                    action: "accept"
                    protocol: "icmp"
                    icmp:
                      type_name: any
              - name: "MAN-from-LOCAL-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 5
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "MAN-from-WAN-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
              - name: "NOWAN-from-HOME-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 20
                    description: "Allow specific hosts ({{ ansible_managed }})"
                    action: "accept"
                    state:
                      new: true
                    source:
                      group:
                        address_group: "NOWAN-TALKERS-from-HOME-v4"
              - name: "NOWAN-from-LOCAL-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 5
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "SERVICE82-from-HOME-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      address: "10.82.0.2"
                      group:
                        port_group: "UNIFI-WEB-TCP"
                    protocol: "tcp"
              - name: "SERVICE82-from-LOCAL-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 5
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "SERVICE82-from-UNIFI-MAN-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      address: "10.82.0.2"
                      group:
                        port_group: "UNIFI-DEVICE-TCP"
                    protocol: "tcp"
                  - number: 11
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      address: "10.82.0.2"
                      group:
                        port_group: "UNIFI-DEVICE-UDP"
                    protocol: "udp"
              - name: "SERVICE82-from-WAN-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 10
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      address: "10.82.0.2"
                      group:
                        port_group: "UNIFI-DEVICE-TCP"
                    protocol: "tcp"
                  - number: 11
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      address: "10.82.0.2"
                      group:
                        port_group: "UNIFI-DEVICE-UDP"
                    protocol: "udp"
                  - number: 12
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
                    destination:
                      address: "10.82.0.2"
                      group:
                        port_group: "UNIFI-WEB-TCP"
                    protocol: "tcp"
              - name: "UNIFI-MAN-from-LOCAL-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 5
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "UNIFI-MAN-from-SERVICE82-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
              - name: "UNIFI-MAN-from-WAN-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
              - name: "WAN-from-GUEST-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 5
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "WAN-from-GWORK-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 5
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "WAN-from-HOME-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 5
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "WAN-from-IOT-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 5
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "WAN-from-LOCAL-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 5
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "WAN-from-MAN-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 5
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
              - name: "WAN-from-SERVICE82-v4"
                description: "{{ ansible_managed }}"
                default_action: "drop"
                rules:
                  - number: 1
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      established: true
                      related: true
                  - number: 2
                    description: "{{ ansible_managed }}"
                    action: "drop"
                    state:
                      invalid: true
                  - number: 5
                    description: "{{ ansible_managed }}"
                    action: "accept"
                    state:
                      new: true
        state: replaced
    - name: "Set Zone Policy"
      vyos.vyos.vyos_config:
        lines:
          # GUEST Zone
          - "set zone-policy zone GUEST default-action drop"
          - "set zone-policy zone GUEST description 'guest network ({{ ansible_managed }})'"
          - "set zone-policy zone GUEST from LOCAL firewall name GUEST-from-LOCAL-v4"
          - "set zone-policy zone GUEST from WAN-Cellular firewall name GUEST-from-WAN-v4"
          - "set zone-policy zone GUEST from WAN-CenturyLink firewall name GUEST-from-WAN-v4"
          - "set zone-policy zone GUEST interface {{ vyos__lan_interface }}.131"
          # GWORK Zone
          - "set zone-policy zone GWORK default-action drop"
          - "set zone-policy zone GWORK description 'work network ({{ ansible_managed }})'"
          - "set zone-policy zone GWORK from LOCAL firewall name GWORK-from-LOCAL-v4"
          - "set zone-policy zone GWORK from WAN-Cellular firewall name GWORK-from-WAN-v4"
          - "set zone-policy zone GWORK from WAN-CenturyLink firewall name GWORK-from-WAN-v4"
          - "set zone-policy zone GWORK interface {{ vyos__lan_interface }}.15"
          # HOME Zone
          - "set zone-policy zone HOME default-action drop"
          - "set zone-policy zone HOME description 'home network with home services ({{ ansible_managed }})'"
          - "set zone-policy zone HOME from IOT firewall name HOME-from-IOT-v4"
          - "set zone-policy zone HOME from LOCAL firewall name HOME-from-LOCAL-v4"
          - "set zone-policy zone HOME from MAN firewall name HOME-from-MAN-v4"
          - "set zone-policy zone HOME from SERVICE82 firewall name HOME-from-SERVICE82-v4"
          - "set zone-policy zone HOME from UNIFI-MAN firewall name HOME-from-UNIFI-MAN-v4"
          # - "set zone-policy zone HOME from NOWAN firewall ipv6-name HOME-from-NOWAN-v6"
          - "set zone-policy zone HOME from NOWAN firewall name HOME-from-NOWAN-v4"
          - "set zone-policy zone HOME from WAN-Cellular firewall name HOME-from-WAN-v4"
          - "set zone-policy zone HOME from WAN-CenturyLink firewall name HOME-from-WAN-v4"
          - "set zone-policy zone HOME interface {{ vyos__lan_interface }}.117"
          # IOT Zone
          - "set zone-policy zone IOT default-action drop"
          - "set zone-policy zone IOT description 'IoT network ({{ ansible_managed }})'"
          - "set zone-policy zone IOT from HOME firewall name IOT-from-HOME-v4"
          - "set zone-policy zone IOT from LOCAL firewall name IOT-from-LOCAL-v4"
          - "set zone-policy zone IOT from WAN-Cellular firewall name IOT-from-WAN-v4"
          - "set zone-policy zone IOT from WAN-CenturyLink firewall name IOT-from-WAN-v4"
          - "set zone-policy zone IOT interface {{ vyos__lan_interface }}.66"
          # LOCAL Zone
          - "set zone-policy zone LOCAL default-action drop"
          - "set zone-policy zone LOCAL description '{{ ansible_managed }}'"
          - "set zone-policy zone LOCAL from HOME firewall name LOCAL-from-HOME-v4"
          - "set zone-policy zone LOCAL from MAN firewall name LOCAL-from-MAN-v4"
          - "set zone-policy zone LOCAL from NOWAN firewall name LOCAL-from-NOWAN-v4"
          - "set zone-policy zone LOCAL from WAN-Cellular firewall name LOCAL-from-WAN-v4"
          - "set zone-policy zone LOCAL from WAN-CenturyLink firewall name LOCAL-from-WAN-v4"
          - "set zone-policy zone LOCAL local-zone"
          # MAN Zone
          - "set zone-policy zone MAN default-action drop"
          - "set zone-policy zone MAN description 'management vlan ({{ ansible_managed }})'"
          - "set zone-policy zone MAN from LOCAL firewall name MAN-from-LOCAL-v4"
          - "set zone-policy zone MAN from WAN-Cellular firewall name MAN-from-WAN-v4"
          - "set zone-policy zone MAN from WAN-CenturyLink firewall name MAN-from-WAN-v4"
          - "set zone-policy zone MAN interface {{ vyos__lan_interface }}.10"
          # NOWAN Zone
          - "set zone-policy zone NOWAN default-action drop"
          - "set zone-policy zone NOWAN description 'internet of shit: no WAN or other access ({{ ansible_managed }})'"
          - "set zone-policy zone NOWAN from HOME firewall name NOWAN-from-HOME-v4"
          - "set zone-policy zone NOWAN from LOCAL firewall name NOWAN-from-LOCAL-v4"
          - "set zone-policy zone NOWAN interface {{ vyos__lan_interface }}.67"
          # SERVICE82 Zone
          - "set zone-policy zone SERVICE82 default-action drop"
          - "set zone-policy zone SERVICE82 description 'installation02 - unifi controller ({{ ansible_managed }})'"
          - "set zone-policy zone SERVICE82 from HOME firewall name SERVICE82-from-HOME-v4"
          - "set zone-policy zone SERVICE82 from LOCAL firewall name SERVICE82-from-LOCAL-v4"
          - "set zone-policy zone SERVICE82 from UNIFI-MAN firewall name SERVICE82-from-UNIFI-MAN-v4"
          - "set zone-policy zone SERVICE82 from WAN-Cellular firewall name SERVICE82-from-WAN-v4"
          - "set zone-policy zone SERVICE82 from WAN-CenturyLink firewall name SERVICE82-from-WAN-v4"
          - "set zone-policy zone SERVICE82 interface {{ vyos__lan_interface }}.82"
          # UNIFI-MAN Zone
          - "set zone-policy zone UNIFI-MAN default-action drop"
          - "set zone-policy zone UNIFI-MAN description 'unifi management vlan ({{ ansible_managed }})'"
          - "set zone-policy zone UNIFI-MAN from LOCAL firewall name UNIFI-MAN-from-LOCAL-v4"
          - "set zone-policy zone UNIFI-MAN from SERVICE82 firewall name UNIFI-MAN-from-SERVICE82-v4"
          - "set zone-policy zone UNIFI-MAN from WAN-Cellular firewall name UNIFI-MAN-from-WAN-v4"
          - "set zone-policy zone UNIFI-MAN from WAN-CenturyLink firewall name UNIFI-MAN-from-WAN-v4"
          - "set zone-policy zone UNIFI-MAN interface {{ vyos__lan_interface }}.1"
          # WAN-Cellular Zone
          - "set zone-policy zone WAN-Cellular default-action drop"
          - "set zone-policy zone WAN-Cellular description 'Cellular WAN connection ({{ ansible_managed }})'"
          - "set zone-policy zone WAN-Cellular from GUEST firewall name WAN-from-GUEST-v4"
          - "set zone-policy zone WAN-Cellular from GWORK firewall name WAN-from-GWORK-v4"
          - "set zone-policy zone WAN-Cellular from HOME firewall name WAN-from-HOME-v4"
          - "set zone-policy zone WAN-Cellular from IOT firewall name WAN-from-IOT-v4"
          - "set zone-policy zone WAN-Cellular from LOCAL firewall name WAN-from-LOCAL-v4"
          - "set zone-policy zone WAN-Cellular from MAN firewall name WAN-from-MAN-v4"
          - "set zone-policy zone WAN-Cellular from SERVICE82 firewall name WAN-from-SERVICE82-v4"
          - "set zone-policy zone WAN-Cellular interface {{ vyos__wan_cellular_interface }}"
          # WAN-CenturyLink Zone
          - "set zone-policy zone WAN-CenturyLink default-action drop"
          - "set zone-policy zone WAN-CenturyLink description 'CenturyLink WAN connection ({{ ansible_managed }})'"
          - "set zone-policy zone WAN-CenturyLink from GUEST firewall name WAN-from-GUEST-v4"
          - "set zone-policy zone WAN-CenturyLink from GWORK firewall name WAN-from-GWORK-v4"
          - "set zone-policy zone WAN-CenturyLink from HOME firewall name WAN-from-HOME-v4"
          - "set zone-policy zone WAN-CenturyLink from IOT firewall name WAN-from-IOT-v4"
          - "set zone-policy zone WAN-CenturyLink from LOCAL firewall name WAN-from-LOCAL-v4"
          - "set zone-policy zone WAN-CenturyLink from MAN firewall name WAN-from-MAN-v4"
          - "set zone-policy zone WAN-CenturyLink from SERVICE82 firewall name WAN-from-SERVICE82-v4"
          - "set zone-policy zone WAN-CenturyLink interface pppoe0"
        save: yes

    #
    # Services
    #
    - name: "Setup SSH"
      vyos.vyos.vyos_config:
        lines:
          - "set service ssh port 22"
          - "set service ssh listen-address 10.10.0.{{ vyos__host_id_ipv4 }}"
          - "set service ssh listen-address fd36:3eb3:43b0:a::{{ vyos__host_id_ipv6 }}"
          - "set service ssh disable-password-authentication"
          - "set system login user ansible full-name 'ansible'"
          - "set system login user ansible authentication public-keys 'sdwilsh-dev' key '{{ common__ansible_key }}'"
          - "set system login user ansible authentication public-keys 'sdwilsh-dev' type '{{ common__ansible_key_type }}'"
        save: yes
    - name: "Setup DHCP"
      vyos.vyos.vyos_config:
        lines:
          - "set service dhcp-server global-parameters 'option space ubnt;'"
          - "set service dhcp-server global-parameters 'option ubnt.unifi-address code 1 = ip-address;'"
          - "set service dhcp-server global-parameters 'class &quot;ubnt&quot; { match if substring (option vendor-class-identifier, 0, 4) = &quot;ubnt&quot;; option vendor-class-identifier &quot;ubnt&quot;; vendor-option-space ubnt; }'"
          # UNIFI-MAN
          - "set service dhcp-server shared-network-name UNIFI-MAN subnet 10.1.0.0/24 default-router 10.1.0.1"
          - "set service dhcp-server shared-network-name UNIFI-MAN subnet 10.1.0.0/24 dns-server 10.117.0.3"
          - "set service dhcp-server shared-network-name UNIFI-MAN subnet 10.1.0.0/24 dns-server 10.117.0.4"
          - "set service dhcp-server shared-network-name UNIFI-MAN subnet 10.1.0.0/24 range 0 start 10.1.0.200"
          - "set service dhcp-server shared-network-name UNIFI-MAN subnet 10.1.0.0/24 range 0 stop 10.1.0.250"
          - "set service dhcp-server shared-network-name UNIFI-MAN subnet 10.1.0.0/24 subnet-parameters 'option ubnt.unifi-address 10.82.0.2;'"
          # MAN
          - "set service dhcp-server shared-network-name MAN subnet 10.10.0.0/24 default-router 10.10.0.1"
          - "set service dhcp-server shared-network-name MAN subnet 10.10.0.0/24 dns-server 10.117.0.3"
          - "set service dhcp-server shared-network-name MAN subnet 10.10.0.0/24 dns-server 10.117.0.4"
          - "set service dhcp-server shared-network-name MAN subnet 10.10.0.0/24 range 0 start 10.10.0.200"
          - "set service dhcp-server shared-network-name MAN subnet 10.10.0.0/24 range 0 stop 10.10.0.250"
          # GWORK
          - "set service dhcp-server shared-network-name GWORK subnet 192.168.1.0/24 default-router 192.168.1.1"
          - "set service dhcp-server shared-network-name GWORK subnet 192.168.1.0/24 dns-server 1.1.1.1"
          - "set service dhcp-server shared-network-name GWORK subnet 192.168.1.0/24 dns-server 1.0.0.1"
          - "set service dhcp-server shared-network-name GWORK subnet 192.168.1.0/24 range 0 start 192.168.1.100"
          - "set service dhcp-server shared-network-name GWORK subnet 192.168.1.0/24 range 0 stop 192.168.1.250"
          # IOT
          - "set service dhcp-server shared-network-name IOT subnet 10.66.0.0/24 default-router 10.66.0.1"
          - "set service dhcp-server shared-network-name IOT subnet 10.66.0.0/24 dns-server 10.117.0.3"
          - "set service dhcp-server shared-network-name IOT subnet 10.66.0.0/24 dns-server 10.117.0.4"
          - "set service dhcp-server shared-network-name IOT subnet 10.66.0.0/24 range 0 start 10.66.0.200"
          - "set service dhcp-server shared-network-name IOT subnet 10.66.0.0/24 range 0 stop 10.66.0.250"
          # NOWAN
          - "set service dhcp-server shared-network-name NOWAN subnet 10.67.0.0/24 default-router 10.67.0.1"
          - "set service dhcp-server shared-network-name NOWAN subnet 10.67.0.0/24 dns-server 10.117.0.3"
          - "set service dhcp-server shared-network-name NOWAN subnet 10.67.0.0/24 dns-server 10.117.0.4"
          - "set service dhcp-server shared-network-name NOWAN subnet 10.67.0.0/24 range 0 start 10.67.0.200"
          - "set service dhcp-server shared-network-name NOWAN subnet 10.67.0.0/24 range 0 stop 10.67.0.250"
          # HOME
          - "set service dhcp-server shared-network-name HOME subnet 10.117.0.0/23 default-router 10.117.0.1"
          - "set service dhcp-server shared-network-name HOME subnet 10.117.0.0/23 dns-server 10.117.0.3"
          - "set service dhcp-server shared-network-name HOME subnet 10.117.0.0/23 dns-server 10.117.0.4"
          - "set service dhcp-server shared-network-name HOME subnet 10.117.0.0/23 range 0 start 10.117.1.1"
          - "set service dhcp-server shared-network-name HOME subnet 10.117.0.0/23 range 0 stop 10.117.1.254"
          # GUEST
          - "set service dhcp-server shared-network-name GWORK subnet 10.131.0.0/24 default-router 10.131.0.1"
          - "set service dhcp-server shared-network-name GWORK subnet 10.131.0.0/24 dns-server 1.1.1.1"
          - "set service dhcp-server shared-network-name GWORK subnet 10.131.0.0/24 dns-server 1.0.0.1"
          - "set service dhcp-server shared-network-name GWORK subnet 10.131.0.0/24 range 0 start 10.131.0.100"
          - "set service dhcp-server shared-network-name GWORK subnet 10.131.0.0/24 range 0 stop 10.131.0.250"
        save: yes
